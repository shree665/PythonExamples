# install grequests package first to run following


import requests
import time
import grequests

#Geoserver URL
url = "http://<geoserver_url>/geoserver/<workspace>/wms"

#layer name
layer = "<workspace>:07177d4c-1227-4be4-aecc-56b600e3ed24"

#random bounding boxes
bbox = [
"-2504688.5428486555,2504688.5428486546,0,5009377.085697309",
"0,2504688.5428486546,2504688.5428486555,5009377.085697309",
"-2504688.5428486555,5009377.085697309,0,7514065.628545966",
"0,5009377.085697309,2504688.5428486555,7514065.628545966",
"-2504688.5428486555,-7.081154551613622,0,2504688.5428486546",
"0,-7.081154551613622,2504688.5428486555,2504688.5428486546",
"-5009377.085697311,2504688.5428486546,-2504688.5428486555,5009377.085697309",
"2504688.5428486555,2504688.5428486546,5009377.085697311,5009377.085697309",
"-5009377.085697311,5009377.085697309,-2504688.5428486555,7514065.628545966",
"2504688.5428486555,5009377.085697309,5009377.085697311,7514065.628545966",
"-5009377.085697311,-7.081154551613622,-2504688.5428486555,2504688.5428486546",
"2504688.5428486555,-7.081154551613622,5009377.085697311,2504688.5428486546",
"-2504688.5428486555,7514065.628545966,0,10018754.171394618",
"0,7514065.628545966,2504688.5428486555,10018754.171394618",
"-2504688.5428486555,-2504688.542848655,0,-7.081154551613622",
"0,-2504688.542848655,2504688.5428486555,-7.081154551613622",
"-5009377.085697311,7514065.628545966,-2504688.5428486555,10018754.171394618",
"-7514065.628545966,2504688.5428486546,-5009377.085697311,5009377.085697309",
"5009377.085697311,2504688.5428486546,7514065.628545966,5009377.085697309",
"-5009377.085697311,-2504688.542848655,-2504688.5428486555,-7.081154551613622",
"2504688.5428486555,-2504688.542848655,5009377.085697311,-7.081154551613622",
"-7514065.628545966,5009377.085697309,-5009377.085697311,7514065.628545966",
"5009377.085697311,5009377.085697309,7514065.628545966,7514065.628545966",
"-7514065.628545966,-7.081154551613622,-5009377.085697311,2504688.5428486546",
"5009377.085697311,-7.081154551613622,7514065.628545966,2504688.5428486546",
"-7514065.628545966,7514065.628545966,-5009377.085697311,10018754.171394618",
"5009377.085697311,7514065.628545966,7514065.628545966,10018754.171394618",
"-7514065.628545966,-2504688.542848655,-5009377.085697311,-7.081154551613622",
"5009377.085697311,-2504688.542848655,7514065.628545966,-7.081154551613622",
"-10018754.171394622,2504688.5428486546,-7514065.628545966,5009377.085697309",
"7514065.628545966,2504688.5428486546,10018754.171394622,5009377.085697309",
"-10018754.171394622,5009377.085697309,-7514065.628545966,7514065.628545966",
"7514065.628545966,5009377.085697309,10018754.171394622,7514065.628545966",
"-10018754.171394622,-7.081154551613622,-7514065.628545966,2504688.5428486546",
"7514065.628545966,-7.081154551613622,10018754.171394622,2504688.5428486546",
"-10018754.171394622,7514065.628545966,-7514065.628545966,10018754.171394618",
"7514065.628545966,7514065.628545966,10018754.171394622,10018754.171394618",
"-10018754.171394622,-2504688.542848655,-7514065.628545966,-7.081154551613622",
"7514065.628545966,-2504688.542848655,10018754.171394622,-7.081154551613622"
]

#total number simultanious users
number_users=200

#user certs
headers = {
    'user':'test'
    }
wholeStart = time.time()
goodCalls = 0
badCalls = 0
unsent_request = []
queryParams = []
for i in range(number_users):
    start = time.time()
    for box in bbox:
        querystring = {"LAYERS":layer,"FORMAT":"image/png","REQUEST":"GetMap","STYLES":"","SRS":"EPSG:3857","BBOX":box,"WIDTH":"256","HEIGHT":"256", "TRANSPARENT":"true"}
        queryParams.append(querystring)
        #unsent_request.append(grequests.get(url, headers=headers,  params=querystring))
r = (grequests.get(url, headers=headers,  params=p) for p in queryParams)
response_list = grequests.map(r)
wholeQueryTime = time.time() - wholeStart
print('Query time for total users [' + str(number_users) + '] with request total [' + str(len(queryParams)) + '] is [{}]'.format(wholeQueryTime))

for i in range(len(response_list)):
    r = response_list[i]
    info = r.headers['Content-Type']
    if info=='image/png':
        goodCalls += 1
    else:
        badCalls += 1
    
print('Total good calls: [' + str(goodCalls) + '] with total bad calls: [' + str(badCalls) + ']')